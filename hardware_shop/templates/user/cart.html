{% extends 'base.html' %}
{% load static %}
{% load customtags %}
{% load thumbnail %}
{% block content %}
<script>
    $(document).ready(function () {
        $('.add-one').click(function () {
            let amount = parseInt($(this).next().children('p').text(), 10)
            if (amount > 0) {
                $(this).next().children('p').text(amount + 1)
                $(this).parent().find("input[name='quantity']").attr('value', $(this).next().children('p').text())
                var final_price = Number(document.getElementById("final_price").textContent);
                var final_amount = Number(document.getElementById("final_amount").textContent);
                final_amount += 1
                final_price += parseInt($(this).parent().prev().find("div").find('p[class="card-price"]').text())
                document.getElementById("final_price").textContent = final_price
                document.getElementById("final_amount").textContent = final_amount
            }
        });
        $(document).ready(function () {
            $('.remove-one').click(function () {
                let amount = parseInt($(this).prev().children('p').text(), 10)
                if (amount > 1) {
                    $(this).prev().children('p').text(amount - 1)
                    $(this).parent().find("input[name='quantity']").attr('value', $(this).prev().children('p').text())
                    var final_price = Number(document.getElementById("final_price").textContent);
                    var final_amount = Number(document.getElementById("final_amount").textContent);
                    final_amount -= 1
                    final_price -= parseInt($(this).parent().prev().find("div").find('p[class="card-price"]').text())
                    document.getElementById("final_price").textContent = final_price
                    document.getElementById("final_amount").textContent = final_amount
                } else {
                    toastr.error("Не меньше 1 шт")
                }
            });
        });
    });
</script>
<script>
    $(document).ready(function () {
        $(".delete-product").submit(function () {
            var elem = $(this)
            console.log(elem)
            $.ajax({
                type: 'POST',
                url: $(this).attr('action'),
                data: $(this).serialize(),
                success: function (html) {
                    if (elem.attr('name') == 'delete') {
                        var final_price = Number(document.getElementById("final_price").textContent);
                        var final_amount = Number(document.getElementById("final_amount").textContent);
                        console.log(elem.find("input[name='quantity']").attr('value'))
                        product_amount = parseInt(elem.find("div[class='in-cart']").find("div[class='amount").find("p[name='quantity']").text())
                        final_amount -= product_amount
                        console.log(final_amount)
                        final_price -= parseInt(elem.find("div[class='card-text']").find("div").find('p[class="card-price"]').text()) * product_amount
                        document.getElementById("final_price").textContent = final_price
                        document.getElementById("final_amount").textContent = final_amount
                        elem.remove();
                    } else {
                        if (html['update']) {
                            toastr.success("Данные сохранены")
                        } else {
                            $('#button-form-' + name).remove()
                            $('#window_form').append(html)
                            $('#button-form-' + name).addClass("show");
                        }
                    }
                }
            });
            return false;
        });
    });
</script>
<div class="main-block" name="cart">
    <div class="cart-width">
        <div id="cart-links">
            <a href="{% url 'products:index' %}">Главная</a>
            <p> → </p>
            <a href="{% url 'user:cart'%}">Корзина</a>
        </div>
        <p id="cart-head-text">Корзина</p>
    </div>
    <img id="background_image" src="{% static 'user/cart.png' %}" />
</div>
<div id="close-order" class="main-block">
    <form method="post" action="{% url 'user:cart' %}">
        {% csrf_token %}
        <div class="filter-block">
            <div>
                <div class="filter-block-inner">
                    <div>
                        <p class="filter-text">Итого</p>
                    </div>
                    <div class="card-final">
                        <div class="row-final">
                            <p class="final-text">Количество товара</p>
                            <div style="display: flex;">
                                <p id="final_amount" class="final-text">{{ final_amount }}</p>
                                <p class="final-text">&nbsp;шт.</p>
                            </div>
                        </div>
                        <div class="row-final">
                            <p class="final-text">Товаров на сумму</p>
                            <div style="display: flex;">
                                <p id="final_price" class="final-text">{{ final_price }}</p>
                                <p class="final-text">&nbsp;₽</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-block-inner">
                    <div>
                        <button type="submit" class="button-close" name="close">
                            <p>Оформить заказ</p>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <div id="products">
        {% for order in cart %}
        <form id="{{ order.product.id }}" class="delete-product" name="delete" method="post"
            action="{% url 'products:change_cart' %}">
            {% csrf_token %}
            <div class="card-cart">
                {% thumbnail order.product.main_image "278x208" crop="center" upscale=True as product_image %}
                <img src="{{ product_image.url }}" />
                {% endthumbnail %}
                <div>
                    <div class="card-info">
                        <div class="card-text">
                            <p class="filter-text">{{ order.product.name }}</p>
                            <div style="display: flex;">
                                <p class="card-price">{{ order.product.price }}</p>
                                <p class="card-price">&nbsp;₽</p>
                            </div>
                        </div>
                        <div class="in-cart">
                            <button type="button" class="add-one">
                                <img src="{% static 'card/add.svg' %}" />
                            </button>
                            <div class="amount">
                                <p name="quantity">{{ order.quantity }}</p>
                            </div>
                            <button type="button" class="remove-one">
                                <img src="{% static 'card/remove.svg' %}" />
                            </button>
                            <input type="text" name="quantity" value="{{ order.product.quantity }}" hidden>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="product-info">
                        <div>
                            <p class="product-id">Код товара:</p>
                            <p class="product-id">{{ order.product.id }}</p>
                        </div>
                        <button type="submit" class="button-delete show" name="delete" hidden>
                            <p>Удалить товар</p>
                        </button>
                        <input type="text" name="product" value="{{ order.product.id }}" hidden>
                        <input type="text" name="delete" hidden>
                    </div>
                </div>
            </div>
        </form>
        {% endfor %}
    </div>
</div>
{% endblock %}